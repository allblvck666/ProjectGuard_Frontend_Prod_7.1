import { useEffect, useMemo, useState } from "react";
import axios from "axios";
import "./styles.css";

// ‚ùó –µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç–µ IP/–ø–æ—Ä—Ç ‚Äî –ø—Ä–∞–≤—å—Ç–µ –∏ —Ç—É—Ç, –∏ –≤ App.jsx
const API = "http://192.168.0.107:8000";

/* –ù–µ–±–æ–ª—å—à–∏–µ —É—Ç–∏–ª–∏—Ç—ã UI */
function Row({ children, gap = 8, wrap = true }) {
  return (
    <div
      className="row"
      style={{ alignItems: "center", gap, flexWrap: wrap ? "wrap" : "nowrap" }}
    >
      {children}
    </div>
  );
}

function Confirm({
  title = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
  okText = "OK",
  cancelText = "–û—Ç–º–µ–Ω–∞",
  onOk,
  onCancel,
  children,
  disabled,
}) {
  return (
    <div
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,.5)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 9999,
        padding: 16,
      }}
      onClick={onCancel}
    >
      <div className="card" style={{ width: "100%", maxWidth: 520 }} onClick={(e) => e.stopPropagation()}>
        <h3 style={{ marginTop: 0 }}>{title}</h3>
        <div style={{ margin: "12px 0" }}>{children}</div>
        <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
          <button className="btn secondary" onClick={onCancel}>{cancelText}</button>
          <button className="btn" onClick={onOk} disabled={disabled}>{okText}</button>
        </div>
      </div>
    </div>
  );
}

export default function AdminPage({ onBack }) {
  /* ===== tabs: managers / requests ===== */
  const [tab, setTab] = useState("managers");

  /* ====== MANAGERS ====== */
  const [managers, setManagers] = useState([]); // [{id, name, total, active, success, closed}]
  const [loadingManagers, setLoadingManagers] = useState(false);
  const [newName, setNewName] = useState("");
  const [edit, setEdit] = useState(null); // {id, name, orig}
  const [remove, setRemove] = useState(null); // {id, name, total}
  const [transferTo, setTransferTo] = useState(""); // manager id –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞

  const loadManagers = async () => {
    setLoadingManagers(true);
    try {
      const r = await axios.get(`${API}/api/admin/managers`);
      setManagers(r.data || []);
    } finally {
      setLoadingManagers(false);
    }
  };

  const doAdd = async () => {
    const name = newName.trim();
    if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞");
    await axios.post(`${API}/api/admin/managers`, { name });
    setNewName("");
    await loadManagers();
  };

  const startEdit = (m) => setEdit({ id: m.id, name: m.name, orig: m.name });
  const cancelEdit = () => setEdit(null);
  const saveEdit = async () => {
    const nm = (edit?.name || "").trim();
    if (!nm) return alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    await axios.patch(`${API}/api/admin/managers/${edit.id}`, { name: nm });
    setEdit(null);
    await loadManagers();
  };

  const askRemove = (m) => {
    setTransferTo("");
    setRemove({ id: m.id, name: m.name, total: m.total });
  };
  const cancelRemove = () => setRemove(null);

  const confirmRemove = async () => {
    const params = {};
    if (transferTo) params.transfer_to = transferTo;
    await axios.delete(`${API}/api/admin/managers/${remove.id}`, { params });
    setRemove(null);
    await loadManagers();
  };

  /* ====== EXTEND REQUESTS ====== */
  const [requests, setRequests] = useState([]);
  const [loadingReq, setLoadingReq] = useState(false);
  const [extendBusy, setExtendBusy] = useState(0);

  const loadRequests = async () => {
    setLoadingReq(true);
    try {
      const r = await axios.get(`${API}/api/admin/extend-requests`);
      setRequests(r.data || []);
    } finally {
      setLoadingReq(false);
    }
  };

  const doAdminExtend = async (pid, days = 10) => {
    try {
      setExtendBusy(pid);
      await axios.post(`${API}/api/admin/protections/${pid}/extend-any?days=${days}`);
      await loadRequests();
    } catch (e) {
      alert(e.response?.data?.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–ª–∏—Ç—å");
    } finally {
      setExtendBusy(0);
    }
  };

  /* ===== initial load & tab change ===== */
  useEffect(() => {
    loadManagers();
    loadRequests();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const back = () => {
    if (onBack) onBack();
    else window.history.back();
  };

  const managersOptions = useMemo(
    () => managers.map((m) => ({ value: String(m.id), label: m.name })),
    [managers]
  );

  return (
    <div className="container">
      <div className="header sticky" style={{ gap: 8, alignItems: "center" }}>
        <h1 style={{ marginRight: "auto" }}>üëë –ê–¥–º–∏–Ω–∫–∞</h1>
        <div className="mode-toggle">
          <div
            className={`tag ${tab === "managers" ? "active" : ""}`}
            onClick={() => setTab("managers")}
          >
            –ú–µ–Ω–µ–¥–∂–µ—Ä—ã
          </div>
          <div
            className={`tag ${tab === "requests" ? "active" : ""}`}
            onClick={() => setTab("requests")}
          >
            –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
          </div>
        </div>
        <button className="btn" onClick={back}>‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
      </div>

      {/* ===== TAB: MANAGERS ===== */}
      {tab === "managers" && (
        <div className="card">
          <h3 style={{ marginTop: 0 }}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</h3>

          <Row>
            <input
              className="input"
              style={{ minWidth: 260 }}
              placeholder="–ù–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä‚Ä¶"
              value={newName}
              onChange={(e) => setNewName(e.target.value)}
            />
            <button className="btn" onClick={doAdd}>‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button className="btn secondary" onClick={loadManagers} disabled={loadingManagers}>
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
          </Row>

          <div style={{ marginTop: 12 }}>
            {loadingManagers && <div className="small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>}
            {!loadingManagers && managers.length === 0 && (
              <div className="small">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ üëÜ</div>
            )}
            {!loadingManagers && managers.length > 0 && (
              <div style={{ overflowX: "auto" }}>
                <table className="table" style={{ width: "100%", minWidth: 760 }}>
                  <thead>
                    <tr>
                      <th style={{ textAlign: "left" }}>–ò–º—è</th>
                      <th>–í—Å–µ–≥–æ</th>
                      <th>–ê–∫—Ç–∏–≤–Ω—ã—Ö</th>
                      <th>–£—Å–ø–µ—à–Ω—ã—Ö</th>
                      <th>–ó–∞–∫—Ä—ã—Ç—ã—Ö</th>
                      <th style={{ width: 230 }}>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody>
                    {managers.map((m) => {
                      const isEdit = edit?.id === m.id;
                      return (
                        <tr key={m.id}>
                          <td>
                            {isEdit ? (
                              <input
                                className="input"
                                value={edit.name}
                                onChange={(e) => setEdit((v) => ({ ...v, name: e.target.value }))}
                              />
                            ) : (
                              <b>{m.name}</b>
                            )}
                          </td>
                          <td style={{ textAlign: "center" }}>{m.total}</td>
                          <td style={{ textAlign: "center" }}>{m.active}</td>
                          <td style={{ textAlign: "center" }}>{m.success}</td>
                          <td style={{ textAlign: "center" }}>{m.closed}</td>
                          <td>
                            {isEdit ? (
                              <Row gap={6} wrap={false}>
                                <button className="btn success" onClick={saveEdit}>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button className="btn secondary" onClick={cancelEdit}>–û—Ç–º–µ–Ω–∞</button>
                              </Row>
                            ) : (
                              <Row gap={6} wrap={false}>
                                <button className="btn" onClick={() => startEdit(m)}>‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                                <button className="btn danger" onClick={() => askRemove(m)}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                              </Row>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ===== TAB: REQUESTS ===== */}
      {tab === "requests" && (
        <div className="card">
          <Row>
            <h3 style={{ margin: 0 }}>–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</h3>
            <button className="btn secondary" onClick={loadRequests} disabled={loadingReq}>
              üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
          </Row>

          <div style={{ marginTop: 12 }}>
            {loadingReq && <div className="small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>}
            {!loadingReq && requests.length === 0 && (
              <div className="small">–ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç.</div>
            )}
            {!loadingReq && requests.length > 0 && (
              <div style={{ overflowX: "auto" }}>
                <table className="table" style={{ width: "100%", minWidth: 860 }}>
                  <thead>
                    <tr>
                      <th>ID –∑–∞—â–∏—Ç—ã</th>
                      <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                      <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
                      <th>SKU</th>
                      <th>–ó–∞–ø—Ä–æ—à–µ–Ω–æ</th>
                      <th>–î–Ω–µ–π</th>
                      <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                      <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {requests.map((r) => (
                      <tr key={r.history_id}>
                        <td>#{r.protection_id}</td>
                        <td>{r.manager}</td>
                        <td>{r.partner}</td>
                        <td className="small">{r.sku}</td>
                        <td className="small">
                          {new Date(r.requested_at).toLocaleString()}
                        </td>
                        <td style={{ textAlign: "center" }}>{r.days}</td>
                        <td className="small">{r.expires_at}</td>
                        <td>
                          <Row gap={6} wrap={false}>
                            <button
                              className="btn success"
                              onClick={() => doAdminExtend(r.protection_id, r.days || 10)}
                              disabled={extendBusy === r.protection_id}
                            >
                              ‚úÖ –ü—Ä–æ–¥–ª–∏—Ç—å
                            </button>
                            <button
                              className="btn secondary"
                              onClick={() => doAdminExtend(r.protection_id, 10)}
                              disabled={extendBusy === r.protection_id}
                            >
                              ‚ûï 10 –¥–Ω
                            </button>
                          </Row>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {/* ===== CONFIRM DELETE MANAGER ===== */}
      {remove && (
        <Confirm
          title="–£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
          okText="–£–¥–∞–ª–∏—Ç—å"
          onOk={confirmRemove}
          onCancel={cancelRemove}
          disabled={false}
        >
          <div className="small" style={{ lineHeight: 1.5 }}>
            –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ <b>{remove.name}</b>.
            {remove.total > 0 ? (
              <>
                <br />
                –£ –Ω–µ–≥–æ –µ—Å—Ç—å <b>{remove.total}</b> –∑–∞—â–∏—Ç(—ã). –í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–º—É –∏—Ö
                –ø–µ—Ä–µ–≤–µ—Å—Ç–∏, –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.
                <div style={{ marginTop: 10 }}>
                  <select
                    className="select"
                    value={transferTo}
                    onChange={(e) => setTransferTo(e.target.value)}
                  >
                    <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ ‚Äî</option>
                    {managers
                      .filter((m) => m.id !== remove.id)
                      .map((m) => (
                        <option key={m.id} value={m.id}>
                          {m.name}
                        </option>
                      ))}
                  </select>
                </div>
              </>
            ) : (
              <>
                <br />
                –£ –Ω–µ–≥–æ –Ω–µ—Ç –∑–∞—â–∏—Ç ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å.
              </>
            )}
          </div>
        </Confirm>
      )}
    </div>
  );
}
/* üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü */
@media (max-width: 768px) {
  table.table,
  table.table thead {
    display: none;
  }
  table.table tbody,
  table.table tr,
  table.table td {
    display: block;
    width: 100%;
  }
  table.table tr {
    margin-bottom: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-card);
    padding: 10px;
  }
  table.table td {
    padding: 4px 0;
    font-size: 14px;
  }
  table.table td::before {
    content: attr(data-label);
    display: block;
    font-weight: 600;
    opacity: 0.7;
    margin-bottom: 2px;
  }
}
